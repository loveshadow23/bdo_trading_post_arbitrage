<!DOCTYPE html>
<html>
<head>
    <title>BDO Item Market Search</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <style>
        body { font-family: Arial; background: #222; color: #eee; }
        .container { max-width: 700px; margin: 40px auto; background: #333; padding: 30px; border-radius: 8px; }
        input[type="text"] { width: 90%; padding: 10px; font-size: 1.3em; }
        input[type="submit"] { padding: 10px 22px; font-size: 1.2em; }
        img { max-width: 48px; vertical-align: middle; }
        table.dataTable { width: 100% !important; margin-top: 20px; background: #222; }
        th, td { padding: 12px 12px; border-bottom: 1px solid #444; text-align: center; font-size: 1.15em; }
        th { background: #222; font-size: 1.2em; }
        ul { list-style-type: none; padding: 0; }
        li { margin: 8px 0; }
        li img { max-width: 28px; margin-right: 8px; }
        a { color: #4af; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .dt-center { text-align: center; }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>BDO Item Market Search</h2>
        <form method="post">
            <input type="text" name="item_name" placeholder="Enter item name..." value="{{ query }}">
            <input type="submit" value="Search">
        </form>
        {% if error %}
            <p style="color: #ff6666;">{{ error }}</p>
        {% endif %}
        {% if matches %}
            <h3>Multiple items found:</h3>
            <div style="margin-bottom:10px;">
                Showing 1 to {{ matches|length }} of {{ total_items }} entries (filtered from {{ total_items }} total entries)
            </div>
            <table id="resultTable" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th class="dt-center">ID</th>
                        <th class="dt-center">Image</th>
                        <th class="dt-center">Name</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in matches %}
                    <tr>
                        <td class="dt-center">{{ item.id }}</td>
                        <td class="dt-center">
                            {% if item.image %}
                                <img src="{{ item.image }}" alt="">
                            {% endif %}
                        </td>
                        <td class="dt-center">
                            <a href="/?item_id={{ item.id }}">{{ item.name }}</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <script>
                $(document).ready(function() {
                    $('#resultTable').DataTable({
                        "paging": false,
                        "info": false,
                        "searching": false,
                        "order": []
                    });
                });
            </script>
        {% endif %}
        {% if result %}
            <h3>Result for: {{ result.item_name }} (ID: {{ result.item_id }})</h3>
            {% if result.item_image %}
                <img src="{{ result.item_image }}" alt="Item image">
            {% endif %}
            <div style="margin-top:20px;">
                {% for row in result.market %}
                    <div style="background:#181818; border-radius:8px; padding:18px 18px 10px 18px; margin-bottom:38px; box-shadow:0 2px 8px #0001;">
                        <div style="font-weight:bold; color:#bdf; font-size:1.15em; margin-bottom:12px;">
                            Enhancement Range: <span style="color:#fff;">{{ row["Enhancement Range"] }}</span>
                        </div>
                        <div style="margin-bottom:7px;"><b>Base Price:</b> {{ row["Base Price"]|format_number }}</div>
                        <div style="margin-bottom:7px;"><b>Current Stock:</b> {{ row["Current Stock"]|format_number }}</div>
                        <div style="margin-bottom:7px;"><b>Total Trades:</b> {{ row["Total Trades"]|format_number }}</div>
                        <div style="margin-bottom:7px;"><b>Price Cap (Min):</b> {{ row["Price Cap (Min)"]|format_number }}</div>
                        <div style="margin-bottom:7px;"><b>Price Cap (Max):</b> {{ row["Price Cap (Max)"]|format_number }}</div>
                        <div style="margin-bottom:7px;"><b>Last Sale Price:</b> {{ row["Last Sale Price"]|format_number }}</div>
                        <div style="margin-bottom:7px;"><b>Last Sale Time:</b> {{ row["Last Sale Time"] }}</div>
                        {% if row.orders and row.orders.orders %}
                            <div style="margin-top:12px;">
                                <b>Orders:</b>
                                <table style="width:100%; margin-top:6px; background:#222;">
                                    <thead>
                                        <tr>
                                            <th style="color:#bdf;">Sellers</th>
                                            <th style="color:#bdf;">Prices</th>
                                            <th style="color:#bdf;">Buyers</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% set sorted_orders = row.orders.orders | sort(attribute='price', reverse=true) %}
                                    {% for order in sorted_orders %}
                                        <tr>
                                            <td>{{ order.sellers|format_number }}</td>
                                            <td style="color:#ff5555; font-weight:bold;">{{ order.price|format_number }}</td>
                                            <td>{{ order.buyers|format_number }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                                {% if row.orders.fetch_time is defined %}
                                    <div style="margin:8px 0 0 0; color:#aaa; font-size:0.98em;">
                                        Fetch time: 
                                        {% if row.orders.fetch_time == 0 %}
                                            <span style="color:#6f6;">(cache)</span>
                                        {% elif row.orders.fetch_time > 0 %}
                                            {{ row.orders.fetch_time }} sec
                                        {% else %}
                                            <span style="color:#f66;">(error)</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</body>
</html>
